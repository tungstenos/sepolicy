;; SPDX-FileCopyrightText: 2025 Rahul Sandhu <nvraxn@gmail.com>
;; SPDX-License-Identifier: MIT

(block kbd

  (blockinherit .hybrid.agent.template)

  (allow subj self (capability (sys_tty_config)))

  (call map_file_pattern.type (subj))
  (call read_file_pattern.type (subj))

  (call .locale.data.map_file_pattern.type (subj))
  (call .locale.read_file_pattern.type (subj))

  (call .nss.passwdgroup.type (subj))

  (call .serialtermdev.open_all_chr_files (subj))

  (call .shell.exec.execute_file_files (subj))

  (call .src.search_file_dirs (subj))

  (call .systemd.udev.use_subj_fds (subj))
  (call .systemd.udev.writeinherited_subj_fifo_files (subj))

  (call .tmp.search_file_pattern.type (subj))

  (call .user.home.list_file_dirs (subj))

  (optional kbd_usertermdev
            (call .user.termdev.open_all_chr_files (subj)))

  (block data

    (filecon "/usr/share/X11/xkb" dir file_context)
    (filecon "/usr/share/X11/xkb/.*" any file_context)

    (filecon "/usr/share/xkeyboard-config-2" dir file_context)
    (filecon "/usr/share/xkeyboard-config-2/.*" any file_context)

    (macro data_file_type_transition_file ((type ARG1))
           (call .data.file_type_transition
                 (ARG1 file dir "xkb"))
           (call .data.file_type_transition
                 (ARG1 file dir "xkeyboard-config-2")))

    (macro map_file_files ((type ARG1))
           (allow ARG1 file (file (map))))

    (blockinherit .file.data.template)

    (block map_file_pattern

      (macro type ((type ARG1))
             (typeattributeset typeattr ARG1))

      (typeattribute typeattr)

      (call map_file_files (typeattr))

      (call .data.search_file_pattern.type (typeattr)))

    (block read_file_pattern

      (macro type ((type ARG1))
             (typeattributeset typeattr ARG1))

      (typeattribute typeattr)

      (call list_file_dirs (typeattr))
      (call read_file_files (typeattr))
      (call read_file_lnk_files (typeattr))

      (call .data.search_file_pattern.type (typeattr))))

  (block map_file_pattern

    (macro type ((type ARG1))
           (typeattributeset typeattr ARG1))

    (typeattribute typeattr)

    (call kbd.data.map_file_pattern.type (typeattr)))

  (block read_file_pattern

    (macro type ((type ARG1))
           (typeattributeset typeattr ARG1))

    (typeattribute typeattr)

    (call kbd.data.read_file_pattern.type (typeattr))))

(in file.unconfined

    (call kbd.data.data_file_type_transition_file (typeattr)))

(in after kbd.exec

    (filecon "/usr/bin/chvt" file file_context)
    (filecon "/usr/bin/codepage" file file_context)
    (filecon "/usr/bin/deallocvt" file file_context)
    (filecon "/usr/bin/dumpkeys" file file_context)
    (filecon "/usr/bin/fgconsole" file file_context)
    (filecon "/usr/bin/getkeycodes" file file_context)
    (filecon "/usr/bin/kbd_mode" file file_context)
    (filecon "/usr/bin/kbdinfo" file file_context)
    (filecon "/usr/bin/kbdrate" file file_context)
    (filecon "/usr/bin/loadkeys" file file_context)
    (filecon "/usr/bin/loadunimap" file file_context)
    (filecon "/usr/bin/mapscrn" file file_context)
    (filecon "/usr/bin/mk_modmap" file file_context)
    (filecon "/usr/bin/openvt" file file_context)
    (filecon "/usr/bin/psfxtable" file file_context)
    (filecon "/usr/bin/resizecons" file file_context)
    (filecon "/usr/bin/setfont" file file_context)
    (filecon "/usr/bin/setkeycodes" file file_context)
    (filecon "/usr/bin/setleds" file file_context)
    (filecon "/usr/bin/setlogcons" file file_context)
    (filecon "/usr/bin/setmetamode" file file_context)
    (filecon "/usr/bin/setvesablank" file file_context)
    (filecon "/usr/bin/setvtrgb" file file_context)
    (filecon "/usr/bin/showconsolefont" file file_context)
    (filecon "/usr/bin/showkey" file file_context)
    (filecon "/usr/bin/splitfont" file file_context)
    (filecon "/usr/bin/unicode_stop" file file_context)
    (filecon "/usr/bin/vcstime" file file_context))
