;; SPDX-FileCopyrightText: 2025 Rahul Sandhu <nvraxn@gmail.com>
;; SPDX-License-Identifier: MIT

(in systemd

    (block userrundir

      (blockinherit .dbus.client.template)
      (blockinherit .sys.agent.template)

      (allow subj self create_unix_dgram_socket)

      (allow subj self
             (capability (chown fowner fsetid dac_override dac_read_search
                                sys_admin)))
      (allow subj self (process (setfscreate)))

      (call systemd.logparseenv.type (subj))

      (call systemd.journal.relay_msgs.type (subj))

      (call systemd.login.conf.list_file_dirs (subj))
      (call systemd.login.conf.read_file_files (subj))
      (call systemd.login.sendmsg_subj_dbus.type (subj))

      (call .caplastcap.read_sysctlfile_pattern.type (subj))

      (call .cgroup.getattr_fs_pattern.type (subj))

      (call .crypto.read_sysctlfile_pattern.type (subj))

      (call .file.user.run.delete_all_file (subj))

      (call .ibac.objchange.type (subj))

      (call .ngroupsmax.read_sysctlfile_pattern.type (subj))

      (call .ns.getattr_fs_files_pattern.type (subj))

      (call .nss.passwdgroup.type (subj))

      (call .osrelease.read_sysctlfile_pattern.type (subj))

      (call .proc.getattr_fs_pattern.type (subj))

      (call .random.read_sysctlfile_pattern.type (subj))

      (call .rbac.objchange.type (subj))

      (call .runuser.readwrite_file_dirs (subj))

      (call .selinux.file.read_file_pattern.type (subj))
      (call .selinux.mapread_fs_pattern.type (subj))

      (call .sys.slice.list_cgroupfile_dirs (subj))
      (call .sys.slice.read_cgroupfile_files (subj))

      (call .tmp.list_file_dirs (subj))

      (call .tmp.list_fs_dirs (subj))
      (call .tmp.getattr_fs_pattern.type (subj))
      (call .tmp.mount_fs (subj))
      (call .tmp.quotaget_fs (subj))
      (call .tmp.quotamod_fs (subj))
      (call .tmp.relabelfrom_fs_dirs (subj))
      (call .tmp.unmount_fs (subj))

      (call .user.run.manage_file_dirs (subj))
      (call .user.run.mounton_file_dirs (subj))
      (call .user.run.relabel_file_dirs (subj))

      (call .xattr.getattr_fs_pattern.type (subj))

      (block unit

        (filecon "/usr/lib/systemd/system/user-runtime-dir@.*\.service.*" file
                 file_context)

        (blockinherit .file.unit.template))))

(in after systemd.userrundir.exec

    (filecon "/usr/lib/systemd/systemd-user-runtime-dir" file file_context))
