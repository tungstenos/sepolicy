;; SPDX-FileCopyrightText: 2025 Rahul Sandhu <nvraxn@gmail.com>
;; SPDX-License-Identifier: MIT

(class dbus (acquire_svc send_msg))
(classorder (unordered dbus))

(block dbus

  (macro dontaudit_acquiresvc_subj_dbus ((type ARG1))
         (dontaudit ARG1 subj (dbus (acquire_svc))))

  (macro dontaudit_sendmsg_subj_dbus ((type ARG1))
         (dontaudit ARG1 subj (dbus (send_msg))))

  (blockinherit macro_template)

  (blockinherit .agent.template)

  (allow subj self (capability (audit_write setgid setuid)))
  (allow subj self (process (getcap setcap)))
  (allow subj self create_netlink_audit_socket)
  (allow subj self (netlink_audit_socket (nlmsg nlmsg_relay)))

  (call common.type (subj))

  (call run.manage_file_dirs (subj))
  (call run.manage_file_sock_files (subj))
  (call run.run_file_type_transition_file (subj))

  (call tmpfs.manage_file_files (subj))
  (call tmpfs.map_file_files (subj))
  (call tmpfs.tmp_fs_type_transition_file (subj))

  (call .sys.agent.type (subj))

  (call .sys.user.readwrite_subj_unix_stream_sockets (subj))

  (call .systemd.reload_system (subj))
  (call .systemd.sendmsg_subj_dbus.type (subj))
  (call .systemd.start_system (subj))
  (call .systemd.status_system (subj))

  (call .systemd.notify.type (subj))

  (call .systemd.sessions.run.writeinherited_file_fifo_files (subj))

  (call .systemd.unit.run.start_file_services (subj))
  (call .systemd.unit.run.status_file_services (subj))
  (call .systemd.unit.run.stop_file_services (subj))

  (call .systemd.unit.start_file_services (subj))
  (call .systemd.unit.status_file_services (subj))
  (call .systemd.unit.stop_file_services (subj))

  (call .systemd.inhibit.run.writeinherited_file_fifo_files (subj))

  (block activated

    (block unit

      (macro type ((type ARG1))
             (typeattributeset typeattr ARG1))

      (typeattribute typeattr)

      (allow dbus.subj typeattr (service (start status stop)))))

  (block all_macro_template

    (blockabstract all_macro_template)

    (block acquiresvc_all_dbus

      (macro type ((type ARG1))
             (typeattributeset typeattr ARG1))

      (typeattribute typeattr)

      (allow typeattr .dbus.common.typeattr (dbus (acquire_svc))))

    (block sendmsg_all_dbus

      (macro type ((type ARG1))
             (typeattributeset typeattr ARG1))

      (typeattribute typeattr)

      (allow typeattr .dbus.common.typeattr (dbus (send_msg)))))

  (block client

    (macro dontaudit_sendmsg_all_dbus ((type ARG1))
           (dontaudit ARG1 typeattr (dbus (send_msg))))

    (macro type ((type ARG1))
           (typeattributeset typeattr ARG1))

    (blockinherit all_macro_template)

    (typeattribute typeattr)

    (call dbus.connectto_subj_unix_stream_sockets (typeattr))

    (call dbus.sendmsg_subj_dbus.type (typeattr))

    (call dbus.run.search_file_dirs (typeattr))
    (call dbus.run.write_file_sock_files (typeattr))

    (call .run.search_file_pattern.type (typeattr))

    (block all_macro_template

      (blockabstract all_macro_template)

      (block sendmsg_all_dbus

        (macro type ((type ARG1))
               (typeattributeset typeattr ARG1))

        (typeattribute typeattr)

        (allow typeattr .dbus.client.typeattr (dbus (send_msg))))

      (macro read_all_states ((type ARG1))
             (allow ARG1 typeattr (state (read)))))

    (block macro_template

      (blockabstract macro_template)

      (block sendmsg_subj_dbus

        (macro type ((type ARG1))
               (typeattributeset typeattr ARG1))

        (typeattribute typeattr)

        (allow typeattr subj (dbus (send_msg)))))

    (block template

      (blockabstract template)

      (blockinherit .dbus.client.macro_template)

      (call .dbus.client.type (subj))))

  (block common

    (macro type ((type ARG1))
           (typeattributeset typeattr ARG1))

    (typeattribute typeattr)

    (blockinherit all_macro_template)

    (allow typeattr self (process (getattr)))
    (allow typeattr self create_unix_dgram_socket)
    (allow typeattr self (dbus (send_msg)))
    (allow typeattr self (unix_stream_socket (accept connectto)))

    (call .computeav_selinux_security (typeattr))

    (call conf.list_file_dirs (typeattr))
    (call conf.read_file_files (typeattr))
    (call conf.watch_file_dirs (typeattr))

    (call data.list_file_dirs (typeattr))
    (call data.read_file_files (typeattr))
    (call data.read_file_lnk_files (typeattr))
    (call data.watch_file_dirs (typeattr))

    (call exec.entrypoint_file_files (typeattr))
    (call exec.execute_file_files (typeattr))

    (call .caplastcap.read_sysctlfile_pattern.type (typeattr))

    (call .crypto.read_sysctlfile_pattern.type (typeattr))

    (call .kernel.search_sysfile_pattern.type (typeattr))

    (call .module.search_sysfile_pattern.type (typeattr))

    (call .ngroupsmax.read_sysctlfile_pattern.type (typeattr))

    (call .nss.passwdgroup.type (typeattr))

    (call .proc.getattr_fs_pattern.type (typeattr))

    (call .random.read_nodedev_chr_files (typeattr))

    (call .random.read_sysctlfile_pattern.type (typeattr))

    (call .security.search_fs_dirs (typeattr))

    (call .selinux.default.read_file_pattern.type (typeattr))
    (call .selinux.map_fs_files (typeattr))
    (call .selinux.readwrite_fs_pattern.type (typeattr))

    (call .systemd.journal.relay_msgs.type (typeattr)))

  (block conf

    (filecon "/etc/dbus-1" dir file_context)
    (filecon "/etc/dbus-1/.*" any file_context)

    (filecon "/etc/default/dbus" file file_context)
    (filecon "/etc/default/dbus\..*" file file_context)

    (macro conf_file_type_transition_file ((type ARG1))
           (call .conf.file_type_transition
                 (ARG1 file dir "dbus-1"))
           (call .conf.file_type_transition
                 (ARG1 file file "dbus")))

    (macro watch_file_dirs ((type ARG1))
           (allow ARG1 file (dir (watch))))

    (blockinherit .file.conf.template))

  (block data

    (filecon "/usr/share/dbus-1" dir file_context)
    (filecon "/usr/share/dbus-1/.*" any file_context)

    (macro data_file_type_transition_file ((type ARG1))
           (call .data.file_type_transition
                 (ARG1 file dir "dbus-1")))

    (macro watch_file_dirs ((type ARG1))
           (allow ARG1 file (dir (watch))))

    (blockinherit .file.data.template))

  (block macro_template

    (blockabstract macro_template)

    (block acquiresvc_subj_dbus

      (macro type ((type ARG1))
             (typeattributeset typeattr ARG1))

      (typeattribute typeattr)

      (allow typeattr subj (dbus (acquire_svc))))

    (block sendmsg_subj_dbus

      (macro type ((type ARG1))
             (typeattributeset typeattr ARG1))

      (typeattribute typeattr)

      (allow typeattr subj (dbus (send_msg)))))

  (block nameclient

    (macro type ((type ARG1))
           (typeattributeset typeattr ARG1))

    (blockinherit client.all_macro_template)

    (typeattribute typeattr)

    ;; dbus_contexts: busconfig support
    (allow typeattr self (dbus (acquire_svc)))

    (call dbus.acquiresvc_subj_dbus.type (typeattr))

    (call dbus.client.type (typeattr))

    (block template

      (blockabstract template)

      (blockinherit .dbus.client.template)

      (call .dbus.nameclient.type (subj))))

  (block run

    (filecon "/run/dbus" dir file_context)
    (filecon "/run/dbus/.*" any file_context)

    (macro create_file_files ((type ARG1))
           (allow ARG1 file create_file))

    (macro dontaudit_search_file_dirs ((type ARG1))
           (dontaudit ARG1 file (dir (search))))

    (macro mounton_file_files ((type ARG1))
           (allow ARG1 file mounton_file))

    (macro run_file_type_transition_file ((type ARG1))
           (call .run.file_type_transition
                 (ARG1 file dir "dbus")))

    (macro watch_file_dirs ((type ARG1))
           (allow ARG1 file (dir (watch))))

    (macro watch_file_sock_files ((type ARG1))
           (allow ARG1 file (sock_file (watch))))

    (blockinherit .file.macro_template_dirs)
    (blockinherit .file.macro_template_sock_files)
    (blockinherit .file.run.base_template)

    (call .rbacsep.exempt.obj.type (file)))

  (block silenced

    (macro type ((type ARG1))
           (typeattributeset typeattr ARG1))

    (typeattribute typeattr)

    (dontaudit typeattr self (dbus (acquire_svc)))
    (dontaudit typeattr typeattr (dbus (send_msg)))

    (call dbus.dontaudit_acquiresvc_subj_dbus (typeattr))
    (call dbus.dontaudit_sendmsg_subj_dbus (typeattr))

    (call dbus.client.dontaudit_sendmsg_all_dbus (typeattr)))

  (block state

    (filecon "/var/lib/dbus" dir file_context)
    (filecon "/var/lib/dbus/.*" any file_context)

    (macro state_file_type_transition_file ((type ARG1))
           (call .state.file_type_transition
                 (ARG1 file dir "dbus")))

    (blockinherit .file.macro_template_dirs)
    (blockinherit .file.macro_template_files)
    (blockinherit .file.macro_template_lnk_files)
    (blockinherit .file.state.base_template))

  (block tmpfs

    (macro map_file_files ((type ARG1))
           (allow ARG1 file (file (map))))

    (macro tmp_fs_type_transition_file ((type ARG1))
           (call .tmp.fs_type_transition
                 (ARG1 file file "*")))

    (blockinherit .file.macro_template_files)
    (blockinherit .file.tmpfs.base_template))

  (block unconfined

    (macro type ((type ARG1))
           (typeattributeset typeattr ARG1))

    (typeattribute typeattr)

    (allow typeattr self (dbus (acquire_svc)))
    (allow typeattr typeattr (dbus (send_msg)))

    (call dbus.acquiresvc_subj_dbus.type (typeattr))
    (call dbus.sendmsg_subj_dbus.type (typeattr))

    (call dbus.client.sendmsg_all_dbus.type (typeattr))

    (block sendmsg_all_dbus

      (macro type ((type ARG1))
             (typeattributeset typeattr ARG1))

      (typeattribute typeattr)

      (allow typeattr dbus.unconfined.typeattr (dbus (send_msg)))))

  (block unit

    (filecon "/usr/lib/systemd/system/dbus-broker\.service.*" file file_context)
    (filecon "/usr/lib/systemd/system/dbus\.service.*" file file_context)
    (filecon "/usr/lib/systemd/system/dbus\.socket.*" file file_context)

    (blockinherit .file.unit.template))

  ;; specific to "sd-bus": systemd services that own a name on the system
  ;; bus monitor availability of DBus (Dbus is optional to systemd)
  (block monitoravailability

    (macro type ((type ARG1))
           (typeattributeset typeattr ARG1))

    (typeattribute typeattr)

    (call dbus.run.listinherited_file_dirs (typeattr))
    (call dbus.run.watch_file_dirs (typeattr))

    (call dbus.run.readinherited_file_sock_files (typeattr))
    (call dbus.run.watch_file_sock_files (typeattr))

    (call .root.listinherited_file_dirs (typeattr))
    (call .root.watch_file_dirs (typeattr))

    (call .run.listinherited_file_dirs (typeattr))
    (call .run.watch_file_dirs (typeattr))))

(in file.unconfined

    (call .dbus.conf.conf_file_type_transition_file (typeattr))
    (call .dbus.data.data_file_type_transition_file (typeattr))
    (call .dbus.run.run_file_type_transition_file (typeattr))
    (call .dbus.state.state_file_type_transition_file (typeattr)))

(in invalid.silenced

    (dontaudit typeattr .invalid (dbus (all))))

(in invalid.unconfined

    (allow typeattr .invalid (dbus (all))))

(in rbacsep

    (constrain (dbus (send_msg))
               (or (or (or (or (eq r1 r2)
                               (and (eq r1 exempt.roleattr)
                                    (neq t1 constrained.typeattr)))
                           (eq t1 exempt.subj.typeattr))
                       (and (eq r1 .sys.role) (eq t1 .dbus.subj)))
                   (eq r2 .sys.role))))

(in sys.user

    (block sendmsg_subj_dbus

      (macro type ((type ARG1))
             (typeattributeset typeattr ARG1))

      (typeattribute typeattr)

      (allow typeattr subj (dbus (send_msg)))))

(in systemd

    ;; For dbus.socket
    (call .dbus.subj_type_transition (subj))

    (block sendmsg_subj_dbus

      (macro type ((type ARG1))
             (typeattributeset typeattr ARG1))

      (typeattribute typeattr)

      (allow typeattr subj (dbus (send_msg)))))

(in systemd.executor

    (call .dbus.subj_type_transition (subj)))

(in silenced

    (call .dbus.silenced.type (typeattr)))

(in unconfined

    (call .dbus.unconfined.type (typeattr)))

(in after dbus.exec

    (filecon "/usr/bin/dbus-broker" file file_context)
    (filecon "/usr/bin/dbus-broker-launch" file file_context)

    (filecon "/usr/bin/dbus-daemon" file file_context)
    (filecon "/usr/bin/dbus-daemon-launch-helper" file file_context)

    (call .hybrid.agent.exec.type (file)))
